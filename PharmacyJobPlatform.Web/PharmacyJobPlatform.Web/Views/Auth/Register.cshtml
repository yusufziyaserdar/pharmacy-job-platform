@model PharmacyJobPlatform.Web.Models.Auth.RegisterViewModel

@{
    ViewData["Title"] = "Kayıt Ol";
}

<div class="row justify-content-center">
    <div class="col-md-8">
        <div class="card shadow-sm mt-5">
            <div class="card-body p-4">

                <h3 class="text-center mb-4">
                    <i class="fa-solid fa-user-plus"></i> Kayıt Ol
                </h3>

                <form asp-controller="Auth" 
                    asp-action="Register"
                      method="post"
                      enctype="multipart/form-data">

                    <div asp-validation-summary="ModelOnly" class="text-danger mb-3"></div>

                    <!-- ROLE -->
                    <div class="mb-3">
                        <label class="form-label">Hesap Türü</label>
                        <select asp-for="Role" class="form-select" id="roleSelect">
                            <option value="">Seçiniz</option>
                            <option value="Worker">Çalışan</option>
                            <option value="PharmacyOwner">Eczane Sahibi</option>
                        </select>
                    </div>

                    <!-- PERSONAL -->
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label asp-for="FirstName"></label>
                            <input asp-for="FirstName" class="form-control" />
                        </div>
                        <div class="col-md-6 mb-3">
                            <label asp-for="LastName"></label>
                            <input asp-for="LastName" class="form-control" />
                        </div>
                    </div>

                    <div class="mb-3">
                        <label asp-for="Email"></label>
                        <input asp-for="Email" class="form-control" />
                    </div>

                    <div class="mb-3">
                        <label asp-for="Password"></label>
                        <input asp-for="Password" class="form-control" />
                    </div>

                    <div class="mb-3">
                        <label asp-for="PhoneNumber">Telefon</label>
                        <input asp-for="PhoneNumber" class="form-control" />
                    </div>

                    <div class="mb-3">
                        <label asp-for="About">Hakkımda</label>
                        <textarea asp-for="About" rows="3" class="form-control"></textarea>
                    </div>

                    <div class="mb-3">
                        <label asp-for="ProfileImage">Profil Fotoğrafı</label>
                        <input asp-for="ProfileImage" type="file" class="form-control" />
                    </div>

                    <!-- ================= WORKER ================= -->
                    <div id="workerSection" class="d-none">
                        <hr />
                        <h5><i class="fa-solid fa-briefcase"></i> Çalışma Geçmişi</h5>

                        <div class="border rounded p-3 mb-3">
                            <label>Eczane Adı</label>
                            <input name="WorkExperiences[0].PharmacyName" class="form-control" />

                            <div class="row mt-2">
                                <div class="col-md-6">
                                    <label>Başlangıç</label>
                                    <input name="WorkExperiences[0].StartDate" type="date" class="form-control" />
                                </div>
                                <div class="col-md-6">
                                    <label>Bitiş</label>
                                    <input name="WorkExperiences[0].EndDate" type="date" class="form-control" />
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- ================= PHARMACY OWNER ================= -->
                    <div id="ownerSection" class="d-none">
                        <hr />
                        <h5><i class="fa-solid fa-location-dot"></i> Eczane Adresi</h5>

                        <div class="mb-3">
                            <label>Şehir</label>
                            <select asp-for="Address.City" id="citySelect" class="form-select">
                                <option value="">Şehir seçiniz</option>
                            </select>
                        </div>

                        <div class="mb-3">
                            <label>İlçe</label>
                            <select asp-for="Address.District" id="districtSelect" class="form-select" disabled>
                                <option value="">İlçe seçiniz</option>
                            </select>
                        </div>

                        <div class="mb-3">
                            <label>Mahalle</label>
                            <select asp-for="Address.Neighborhood" id="neighborhoodSelect" class="form-select" disabled>
                                <option value="">Mahalle seçiniz</option>
                            </select>
                        </div>

                        <div class="mb-3">
                            <label>Sokak / Cadde</label>
                            <input asp-for="Address.Street" class="form-control" />
                        </div>

                        <div class="mb-3">
                            <label>Bina No</label>
                            <input asp-for="Address.BuildingNumber" class="form-control" />
                        </div>
                    </div>

                    <button type="submit" class="btn btn-success w-100 mt-4">
                        <i class="fa-solid fa-check"></i> Kayıt Ol
                    </button>
                </form>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <partial name="_ValidationScriptsPartial" />

    <script>
        const roleSelect = document.getElementById("roleSelect");
        const workerSection = document.getElementById("workerSection");
        const ownerSection = document.getElementById("ownerSection");

        roleSelect.addEventListener("change", () => {
            workerSection.classList.add("d-none");
            ownerSection.classList.add("d-none");

            if (roleSelect.value === "Worker")
                workerSection.classList.remove("d-none");

            if (roleSelect.value === "PharmacyOwner")
                ownerSection.classList.remove("d-none");
        });

        // ================= ADDRESS =================

        let cities = [];
        let districts = [];
        let neighborhoods = [];

        fetch('/data/turkiye-adresler-json/sehirler.json')
            .then(r => {
                if (!r.ok) throw new Error("Şehir JSON yüklenemedi");
                return r.json();
            })
            .then(data => {
                const citySelect = document.getElementById("citySelect");
                data.forEach(c => {
                    citySelect.insertAdjacentHTML(
                        "beforeend",
                        `<option value="${c.sehir_adi}" data-id="${c.sehir_id}">
                            ${c.sehir_adi}
                         </option>`
                    );
                });
            })
            .catch(err => console.error(err));


        fetch('/data/turkiye-adresler-json/ilceler.json')
            .then(r => r.json())
            .then(data => districts = data);

        Promise.all([
            fetch('/data/turkiye-adresler-json/mahalleler-1.json').then(r => r.json()),
            fetch('/data/turkiye-adresler-json/mahalleler-2.json').then(r => r.json()),
            fetch('/data/turkiye-adresler-json/mahalleler-3.json').then(r => r.json()),
            fetch('/data/turkiye-adresler-json/mahalleler-4.json').then(r => r.json())
        ]).then(results => {
            neighborhoods = results.flat();
        });

        document.getElementById("citySelect").addEventListener("change", function () {
            const cityId = this.selectedOptions[0].dataset.id;
            const districtSelect = document.getElementById("districtSelect");

            districtSelect.innerHTML = '<option value="">İlçe seçiniz</option>';
            districtSelect.disabled = false;

            districts
                .filter(d => d.sehir_id === cityId)
                .forEach(d => {
                    districtSelect.innerHTML +=
                        `<option value="${d.ilce_adi}" data-id="${d.ilce_id}">${d.ilce_adi}</option>`;
                });
        });

        document.getElementById("districtSelect").addEventListener("change", function () {
            const ilceId = this.selectedOptions[0].dataset.id;
            const neighborhoodSelect = document.getElementById("neighborhoodSelect");

            neighborhoodSelect.innerHTML = '<option value="">Mahalle seçiniz</option>';
            neighborhoodSelect.disabled = false;

            neighborhoods
                .filter(n => n.ilce_id === ilceId)
                .forEach(n => {
                    neighborhoodSelect.innerHTML +=
                        `<option value="${n.mahalle_adi}">${n.mahalle_adi}</option>`;
                });
        });
    </script>
}
