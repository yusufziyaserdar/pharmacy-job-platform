@model PharmacyJobPlatform.Web.Models.Auth.RegisterViewModel

@{
    ViewData["Title"] = "Kayıt Ol";
}

<div class="row justify-content-center">
    <div class="col-md-8">
        <div class="card shadow-sm mt-5">
            <div class="card-body p-4">

                <h3 class="text-center mb-4">
                    <i class="fa-solid fa-user-plus"></i> Kayıt Ol
                </h3>

                <form asp-controller="Auth" 
                    asp-action="Register"
                      method="post"
                      enctype="multipart/form-data">

                    <div asp-validation-summary="ModelOnly" class="text-danger mb-3"></div>

                    <!-- ROLE -->
                    <div class="mb-3">
                        <label class="form-label">Hesap Türü</label>
                        <select asp-for="Role" class="form-select" id="roleSelect">
                            <option value="">Seçiniz</option>
                            <option value="Worker">Çalışan</option>
                            <option value="PharmacyOwner">Eczane Sahibi</option>
                        </select>
                    </div>

                    <!-- PERSONAL -->
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label asp-for="FirstName"></label>
                            <input asp-for="FirstName" class="form-control" />
                        </div>
                        <div class="col-md-6 mb-3">
                            <label asp-for="LastName"></label>
                            <input asp-for="LastName" class="form-control" />
                        </div>
                    </div>

                    <div class="mb-3">
                        <label asp-for="Email"></label>
                        <input asp-for="Email" class="form-control" />
                    </div>

                    <div class="mb-3">
                        <label asp-for="Password"></label>
                        <input asp-for="Password" class="form-control" />
                    </div>

                    <div class="mb-3">
                        <label asp-for="PhoneNumber">Telefon</label>
                        <input asp-for="PhoneNumber" class="form-control" />
                    </div>

                    <div class="mb-3">
                        <label asp-for="About">Hakkımda</label>
                        <textarea asp-for="About" rows="3" class="form-control"></textarea>
                    </div>

                    <div class="mb-3">
                        <label asp-for="ProfileImage">Profil Fotoğrafı</label>
                        <input asp-for="ProfileImage" type="file" class="form-control" />
                    </div>

                    <!-- ================= WORKER ================= -->
                    <div id="workerSection" class="d-none">
                        <hr />
                        <h5><i class="fa-solid fa-briefcase"></i> Çalışma Geçmişi</h5>

                        <div id="experience-list">
                            <div class="card mb-3 experience-item">
                                <div class="card-body">
                                    <div class="mb-2">
                                        <label>Eczane Adı</label>
                                        <input name="WorkExperiences[0].PharmacyName" class="form-control" />
                                    </div>

                                    <div class="row">
                                        <div class="col-md-6">
                                            <label>Başlangıç</label>
                                            <input name="WorkExperiences[0].StartDate" type="date" class="form-control" />
                                        </div>
                                        <div class="col-md-6">
                                            <label>Bitiş</label>
                                            <input name="WorkExperiences[0].EndDate" type="date" class="form-control" />
                                        </div>
                                    </div>

                                    <button type="button"
                                            class="btn btn-sm btn-danger mt-3 remove-experience">
                                        <i class="fa-solid fa-trash"></i> Sil
                                    </button>
                                </div>
                            </div>
                        </div>

                        <button type="button"
                                id="add-experience"
                                class="btn btn-outline-secondary mb-3">
                            <i class="fa-solid fa-plus"></i> Tecrübe Ekle
                        </button>
                    </div>

                    <!-- ================= PHARMACY OWNER ================= -->
                    <div id="ownerSection" class="d-none">
                        <hr />
                        <h5><i class="fa-solid fa-location-dot"></i> Eczane Adresi</h5>

                        <div class="mb-3">
                            <label>Şehir</label>
                            <select asp-for="Address.City" id="citySelect" class="form-select">
                                <option value="">Şehir seçiniz</option>
                            </select>
                        </div>

                        <div class="mb-3">
                            <label>İlçe</label>
                            <select asp-for="Address.District" id="districtSelect" class="form-select" disabled>
                                <option value="">İlçe seçiniz</option>
                            </select>
                        </div>

                        <div class="mb-3">
                            <label>Mahalle</label>
                            <select asp-for="Address.Neighborhood" id="neighborhoodSelect" class="form-select" disabled>
                                <option value="">Mahalle seçiniz</option>
                            </select>
                        </div>

                        <div class="mb-3">
                            <label>Sokak / Cadde</label>
                            <input asp-for="Address.Street" class="form-control" />
                        </div>

                        <div class="mb-3">
                            <label>Bina No</label>
                            <input asp-for="Address.BuildingNumber" class="form-control" />
                        </div>
                    </div>

                    <button type="submit" class="btn btn-success w-100 mt-4">
                        <i class="fa-solid fa-check"></i> Kayıt Ol
                    </button>
                </form>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <partial name="_ValidationScriptsPartial" />

    <script>
        document.addEventListener("DOMContentLoaded", () => {
            const roleSelect = document.getElementById("roleSelect");
            const workerSection = document.getElementById("workerSection");
            const ownerSection = document.getElementById("ownerSection");
            const experienceList = document.getElementById("experience-list");
            const addExperienceButton = document.getElementById("add-experience");

            if (!roleSelect || !workerSection || !ownerSection) {
                return;
            }

            const toggleSectionInputs = (section, enabled) => {
                section.querySelectorAll("input, select, textarea").forEach(el => {
                    el.disabled = !enabled;
                });
            };

            const applyRoleView = () => {
                const isWorker = roleSelect.value === "Worker";
                const isOwner = roleSelect.value === "PharmacyOwner";

                workerSection.classList.toggle("d-none", !isWorker);
                ownerSection.classList.toggle("d-none", !isOwner);

                toggleSectionInputs(workerSection, isWorker);
                toggleSectionInputs(ownerSection, isOwner);
            };

            roleSelect.addEventListener("change", applyRoleView);
            applyRoleView();

            // ================= WORK EXPERIENCE =================
            let experienceIndex = experienceList
                ? experienceList.querySelectorAll(".experience-item").length
                : 0;

            const reindexExperiences = () => {
                if (!experienceList) return;

                const items = experienceList.querySelectorAll(".experience-item");
                items.forEach((item, index) => {
                    item.querySelectorAll("input").forEach(input => {
                        input.name = input.name.replace(/\[\d+\]/, `[${index}]`);
                    });
                });

                experienceIndex = items.length;
            };

            if (addExperienceButton && experienceList) {
                addExperienceButton.addEventListener("click", () => {
                    const html = `
                        <div class="card mb-3 experience-item">
                            <div class="card-body">
                                <div class="mb-2">
                                    <label>Eczane Adı</label>
                                    <input class="form-control"
                                           name="WorkExperiences[${experienceIndex}].PharmacyName" />
                                </div>

                                <div class="row">
                                    <div class="col-md-6">
                                        <label>Başlangıç</label>
                                        <input type="date"
                                               class="form-control"
                                               name="WorkExperiences[${experienceIndex}].StartDate" />
                                    </div>

                                    <div class="col-md-6">
                                        <label>Bitiş</label>
                                        <input type="date"
                                               class="form-control"
                                               name="WorkExperiences[${experienceIndex}].EndDate" />
                                    </div>
                                </div>

                                <button type="button"
                                        class="btn btn-sm btn-danger mt-3 remove-experience">
                                    <i class="fa-solid fa-trash"></i> Sil
                                </button>
                            </div>
                        </div>`;

                    experienceList.insertAdjacentHTML("beforeend", html);
                    experienceIndex++;
                    applyRoleView();
                });
            }

            document.addEventListener("click", event => {
                if (!event.target.closest(".remove-experience")) {
                    return;
                }

                event.target.closest(".experience-item")?.remove();
                reindexExperiences();
            });

            // ================= ADDRESS =================
            let districts = [];
            let neighborhoods = [];

            fetch('/data/turkiye-adresler-json/sehirler.json')
                .then(r => {
                    if (!r.ok) throw new Error("Şehir JSON yüklenemedi");
                    return r.json();
                })
                .then(data => {
                    const citySelect = document.getElementById("citySelect");
                    if (!citySelect) return;

                    data.forEach(c => {
                        citySelect.insertAdjacentHTML(
                            "beforeend",
                            `<option value="${c.sehir_adi}" data-id="${c.sehir_id}">
                                ${c.sehir_adi}
                             </option>`
                        );
                    });
                })
                .catch(err => console.error(err));

            fetch('/data/turkiye-adresler-json/ilceler.json')
                .then(r => {
                    if (!r.ok) throw new Error("İlçe JSON yüklenemedi");
                    return r.json();
                })
                .then(data => { districts = data; })
                .catch(err => console.error(err));

            Promise.all([
                fetch('/data/turkiye-adresler-json/mahalleler-1.json').then(r => {
                    if (!r.ok) throw new Error("Mahalle JSON (1) yüklenemedi");
                    return r.json();
                }),
                fetch('/data/turkiye-adresler-json/mahalleler-2.json').then(r => {
                    if (!r.ok) throw new Error("Mahalle JSON (2) yüklenemedi");
                    return r.json();
                }),
                fetch('/data/turkiye-adresler-json/mahalleler-3.json').then(r => {
                    if (!r.ok) throw new Error("Mahalle JSON (3) yüklenemedi");
                    return r.json();
                }),
                fetch('/data/turkiye-adresler-json/mahalleler-4.json').then(r => {
                    if (!r.ok) throw new Error("Mahalle JSON (4) yüklenemedi");
                    return r.json();
                })
            ])
                .then(results => {
                    neighborhoods = results.flat();
                })
                .catch(err => console.error(err));

            const citySelect = document.getElementById("citySelect");
            const districtSelect = document.getElementById("districtSelect");
            const neighborhoodSelect = document.getElementById("neighborhoodSelect");

            if (!citySelect || !districtSelect || !neighborhoodSelect) {
                return;
            }

            citySelect.addEventListener("change", function () {
                const cityId = this.selectedOptions[0]?.dataset.id;

                districtSelect.innerHTML = '<option value="">İlçe seçiniz</option>';
                districtSelect.disabled = false;
                neighborhoodSelect.innerHTML = '<option value="">Mahalle seçiniz</option>';
                neighborhoodSelect.disabled = true;

                if (!cityId) return;

                districts
                    .filter(d => d.sehir_id === cityId)
                    .forEach(d => {
                        districtSelect.innerHTML +=
                            `<option value="${d.ilce_adi}" data-id="${d.ilce_id}">${d.ilce_adi}</option>`;
                    });
            });

            districtSelect.addEventListener("change", function () {
                const ilceId = this.selectedOptions[0]?.dataset.id;

                neighborhoodSelect.innerHTML = '<option value="">Mahalle seçiniz</option>';
                neighborhoodSelect.disabled = false;

                if (!ilceId) return;

                neighborhoods
                    .filter(n => n.ilce_id === ilceId)
                    .forEach(n => {
                        neighborhoodSelect.innerHTML +=
                            `<option value="${n.mahalle_adi}">${n.mahalle_adi}</option>`;
                    });
            });
        });
    </script>
}
