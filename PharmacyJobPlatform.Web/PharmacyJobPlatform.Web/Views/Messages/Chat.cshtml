@model PharmacyJobPlatform.Domain.Entities.Conversation
@using System.Security.Claims

@{
    int userId = int.Parse(User.FindFirstValue(ClaimTypes.NameIdentifier));

    var otherUser =
        Model.User1Id == userId ? Model.User2 : Model.User1;
}


<div class="row">
    <div class="col-md-8 offset-md-2">

        <div class="card">
            <div class="card-header fw-bold">
                💬
                <a asp-controller="Profile"
                   asp-action="Index"
                   asp-route-id="@otherUser.Id"
                   class="text-decoration-none">
                    @otherUser.FirstName @otherUser.LastName
                </a>
            </div>


            <div class="card-body" id="chatBody" style="height:400px; overflow-y:auto">
                @foreach (var msg in Model.Messages.OrderBy(m => m.SentAt))
                {
                    bool mine = msg.SenderId == userId;

                    <div class="d-flex mb-2 @(mine ? "justify-content-end" : "")">
                        <div class="p-2 rounded @(mine ? "bg-primary text-white" : "bg-light")"
                             style="max-width:70%">
                            @msg.Content
                            <div class="text-end">
                                <small>@msg.SentAt.ToLocalTime().ToString("HH:mm")</small>
                            </div>
                        </div>
                    </div>
                }
            </div>

            <div class="card-footer">
                <form asp-action="SendMessage" method="post">
                    <input type="hidden" name="conversationId" value="@Model.Id" />

                    <div class="input-group">
                        <input name="content" class="form-control" required />
                        <button class="btn btn-primary">Gönder</button>
                    </div>
                </form>
            </div>
        </div>

    </div>
</div>
@section Scripts {
    <script>
        const chatBody = document.getElementById("chatBody");
        if (chatBody) {
            chatBody.scrollTop = chatBody.scrollHeight;
        }
    </script>
}
