@model PharmacyJobPlatform.Web.Models.Profile.ProfileEditViewModel

@{
    var googleMapsApiKey = ViewData["GoogleMapsApiKey"] as string;
    var isPharmacyOwner = ViewData["IsPharmacyOwner"] as bool? ?? false;
    var addressParts = new List<string>();
    if (!string.IsNullOrWhiteSpace(Model.Address?.Street))
    {
        addressParts.Add(Model.Address.Street);
    }

    if (!string.IsNullOrWhiteSpace(Model.Address?.BuildingNumber))
    {
        addressParts.Add(Model.Address.BuildingNumber);
    }

    if (!string.IsNullOrWhiteSpace(Model.Address?.Neighborhood))
    {
        addressParts.Add(Model.Address.Neighborhood);
    }

    if (!string.IsNullOrWhiteSpace(Model.Address?.District))
    {
        addressParts.Add(Model.Address.District);
    }

    if (!string.IsNullOrWhiteSpace(Model.Address?.City))
    {
        addressParts.Add(Model.Address.City);
    }

    var addressSummary = string.Join(", ", addressParts);
}

<form asp-action="Edit" method="post" enctype="multipart/form-data">

    <input type="hidden" asp-for="Id" />

    <div class="mb-3">
        <label>Ad</label>
        <input asp-for="FirstName" class="form-control" />
    </div>

    <div class="mb-3">
        <label>Soyad</label>
        <input asp-for="LastName" class="form-control" />
    </div>

    <div class="mb-3">
        <label>Telefon</label>
        <input asp-for="PhoneNumber" class="form-control" />
    </div>

    <div class="mb-3">
        <label>Hakkında</label>
        <textarea asp-for="About" class="form-control"></textarea>
    </div>

    <div class="mb-3">
        <label>Profil Fotoğrafı</label>
        <input asp-for="ProfileImage" type="file" class="form-control" />
    </div>

    @if (isPharmacyOwner)
    {
        <hr />
        <h5><i class="fa-solid fa-location-dot"></i> Eczane Adresi</h5>

        <div class="mb-3">
            <label>Adres Ara</label>
            <input id="addressAutocomplete"
                   type="text"
                   class="form-control"
                   placeholder="Adres yazmaya başlayın"
                   autocomplete="off"
                   value="@addressSummary" />
        </div>

        <div class="mb-3">
            <label>Şehir</label>
            <input asp-for="Address.City" id="cityInput" class="form-control" readonly />
        </div>

        <div class="mb-3">
            <label>İlçe</label>
            <input asp-for="Address.District" id="districtInput" class="form-control" readonly />
        </div>

        <div class="mb-3">
            <label>Mahalle</label>
            <input asp-for="Address.Neighborhood" id="neighborhoodInput" class="form-control" readonly />
        </div>

        <div class="mb-3">
            <label>Sokak / Cadde</label>
            <input asp-for="Address.Street" id="streetInput" class="form-control" />
        </div>

        <div class="mb-3">
            <label>Bina No</label>
            <input asp-for="Address.BuildingNumber" id="buildingNumberInput" class="form-control" />
        </div>
    }

    <hr />
    <h5>🏥 Çalışma Geçmişi</h5>

    <div id="experience-list">

        @for (int i = 0; i < Model.WorkExperiences.Count; i++)
        {
            <div class="card mb-3 experience-item">
                <div class="card-body">

                    <input type="hidden"
                           name="WorkExperiences[@i].Id"
                           value="@Model.WorkExperiences[i].Id" />

                    <div class="mb-2">
                        <label>Eczane Adı</label>
                        <input class="form-control"
                               name="WorkExperiences[@i].PharmacyName"
                               value="@Model.WorkExperiences[i].PharmacyName" />
                    </div>

                    <div class="row">
                        <div class="col-md-6">
                            <label>Başlangıç</label>
                            <input type="date"
                                   class="form-control"
                                   name="WorkExperiences[@i].StartDate"
                                   value="@Model.WorkExperiences[i].StartDate.ToString("yyyy-MM-dd")" />
                        </div>

                        <div class="col-md-6">
                            <label>Bitiş</label>
                            <input type="date"
                                   class="form-control"
                                   name="WorkExperiences[@i].EndDate"
                                   value="@(Model.WorkExperiences[i].EndDate?.ToString("yyyy-MM-dd"))" />
                        </div>
                    </div>

                    <button type="button"
                            class="btn btn-sm btn-danger mt-3 remove-experience">
                        🗑 Sil
                    </button>

                </div>
            </div>
        }

    </div>

    <button type="button"
            id="add-experience"
            class="btn btn-outline-secondary mb-3">
        ➕ Tecrübe Ekle
    </button>


    <button class="btn btn-success">Kaydet</button>
</form>

@section Scripts {
    <script>
            let experienceIndex = @Model.WorkExperiences.Count;

            document.getElementById("add-experience")
                .addEventListener("click", function () {

                    const container = document.getElementById("experience-list");

                    const html = `
        <div class="card mb-3 experience-item">
            <div class="card-body">

                <div class="mb-2">
                    <label>Eczane Adı</label>
                    <input class="form-control"
                           name="WorkExperiences[${experienceIndex}].PharmacyName" />
                </div>

                <div class="row">
                    <div class="col-md-6">
                        <label>Başlangıç</label>
                        <input type="date"
                               class="form-control"
                               name="WorkExperiences[${experienceIndex}].StartDate" />
                    </div>

                    <div class="col-md-6">
                        <label>Bitiş</label>
                        <input type="date"
                               class="form-control"
                               name="WorkExperiences[${experienceIndex}].EndDate" />
                    </div>
                </div>

                <button type="button"
                        class="btn btn-sm btn-danger mt-3 remove-experience">
                    🗑 Sil
                </button>

            </div>
        </div>`;

                    container.insertAdjacentHTML("beforeend", html);
                    experienceIndex++;
                });

            document.addEventListener("click", function (e) {
                if (e.target.classList.contains("remove-experience")) {
                    e.target.closest(".experience-item").remove();
                    reindexExperiences();
                }
            });

            function reindexExperiences() {
                const items = document.querySelectorAll(".experience-item");

                items.forEach((item, index) => {
                    item.querySelectorAll("input").forEach(input => {
                        input.name = input.name.replace(/\[\d+\]/, `[${index}]`);
                    });
                });

                experienceIndex = items.length;
            }

            const fillAddressInput = (input, value) => {
                if (!input) return;
                input.value = value ?? "";
            };

            const clearAddressInputs = () => {
                fillAddressInput(document.getElementById("cityInput"), "");
                fillAddressInput(document.getElementById("districtInput"), "");
                fillAddressInput(document.getElementById("neighborhoodInput"), "");
                fillAddressInput(document.getElementById("streetInput"), "");
                fillAddressInput(document.getElementById("buildingNumberInput"), "");
            };

            const getComponent = (components, types) => {
                const component = components.find(c => types.some(t => c.types.includes(t)));
                return component?.long_name ?? "";
            };

            const initAddressAutocomplete = () => {
                const addressInput = document.getElementById("addressAutocomplete");
                if (!addressInput || !window.google?.maps?.places) {
                    return;
                }

                const autocomplete = new google.maps.places.Autocomplete(addressInput, {
                    types: ["address"],
                    componentRestrictions: { country: "tr" },
                    fields: ["address_components", "formatted_address"]
                });

                autocomplete.addListener("place_changed", () => {
                    const place = autocomplete.getPlace();
                    if (!place?.address_components) {
                        return;
                    }

                    if (place.formatted_address) {
                        addressInput.value = place.formatted_address;
                    }

                    const components = place.address_components;
                    const city = getComponent(components, ["administrative_area_level_1"]);
                    const district = getComponent(components, ["administrative_area_level_2"]);
                    const neighborhood = getComponent(components, [
                        "sublocality_level_1",
                        "neighborhood",
                        "administrative_area_level_3",
                        "administrative_area_level_4"
                    ]);
                    const street = getComponent(components, ["route"]);
                    const buildingNumber = getComponent(components, ["street_number"]);

                    fillAddressInput(document.getElementById("cityInput"), city);
                    fillAddressInput(document.getElementById("districtInput"), district);
                    fillAddressInput(document.getElementById("neighborhoodInput"), neighborhood);

                    const streetInput = document.getElementById("streetInput");
                    const buildingInput = document.getElementById("buildingNumberInput");

                    if (streetInput && !streetInput.value) {
                        streetInput.value = street;
                    }

                    if (buildingInput && !buildingInput.value) {
                        buildingInput.value = buildingNumber;
                    }
                });

                addressInput.addEventListener("input", () => {
                    if (!addressInput.value) {
                        clearAddressInputs();
                    }
                });
            };

            window.initAddressAutocomplete = initAddressAutocomplete;
    </script>

    @if (isPharmacyOwner)
    {
        if (!string.IsNullOrWhiteSpace(googleMapsApiKey))
        {
            <script src="https://maps.googleapis.com/maps/api/js?key=@googleMapsApiKey&libraries=places&callback=initAddressAutocomplete"
                    async
                    defer></script>
        }
        else
        {
            <script>
                console.warn("Google Maps API anahtarı bulunamadı. Adres otomatik tamamlama çalışmayacak.");
            </script>
        }
    }
}
