@model PharmacyJobPlatform.Web.Models.Profile.ProfileDetailViewModel
@using System.Security.Claims


@{
    var user = Model.User;
    string profileImage = string.IsNullOrEmpty(user.ProfileImagePath)
        ? "/images/profiles/default-profile.png"
        : user.ProfileImagePath;

    int totalMonths = 0;

    if (user.WorkExperiences != null)
    {
        foreach (var exp in user.WorkExperiences)
        {
            var endDate = exp.EndDate ?? DateTime.Today;
            totalMonths += (endDate.Year - exp.StartDate.Year) * 12
                           + endDate.Month - exp.StartDate.Month;
        }
    }

    int years = totalMonths / 12;
    int months = totalMonths % 12;
}

<div class="container mt-4">
    @if (TempData["Success"] is string successMessage)
    {
        <div class="alert alert-success">@successMessage</div>
    }

    @if (TempData["Error"] is string errorMessage)
    {
        <div class="alert alert-danger">@errorMessage</div>
    }

    <div class="card shadow-sm">
        <div class="card-body">

            <!-- PROFIL ÜST -->
            <div class="row align-items-center">
                <div class="col-md-3 text-center">
                    <img src="@profileImage"
                         class="rounded-circle img-fluid mb-3"
                         style="max-width:150px;"
                         alt="Profil Fotoğrafı" />
                </div>

                <div class="col-md-9">
                    <h3 class="mb-1">
                        @user.FirstName @user.LastName
                    </h3>

                    @if(user.Role.Name=="PharmacyOwner")
                    {
                        <span class="badge bg-secondary mb-2">
                            Eczane Sahibi
                        </span>
                    }
                    else
                    {
                        <span class="badge bg-secondary mb-2">
                            Çalışan
                        </span>
                    }

                    <p class="mb-1">
                        <i class="bi bi-envelope me-2"></i>@user.Email
                    </p>

                    @if (!string.IsNullOrEmpty(user.PhoneNumber))
                    {
                        <p class="mb-1">
                            <i class="bi bi-telephone me-2"></i>@user.PhoneNumber
                        </p>
                    }

                    <p class="text-muted">
                        Platforma katılma:
                        @user.CreatedAt.ToShortDateString()
                    </p>

                    @if (User.Identity?.IsAuthenticated == true &&
                    int.Parse(User.FindFirst(ClaimTypes.NameIdentifier)!.Value) == user.Id)
                    {
                        <a asp-controller="Profile"
                           asp-action="Edit"
                           class="btn btn-outline-primary btn-sm float-end">
                            <i class="bi bi-pencil me-2"></i>Profili Düzenle
                        </a>
                    }

                </div>
            </div>

            <hr />

            <!-- ABOUT -->
            @if (!string.IsNullOrEmpty(user.About))
            {
                <h5><i class="bi bi-card-text me-2"></i>Hakkında</h5>
                <p>@user.About</p>
                <hr />
            }

            <h5><i class="bi bi-star-fill me-2 text-warning"></i>Değerlendirme</h5>

            @if (Model.AverageRating.HasValue)
            {
                <p class="mb-2">
                    <strong>@Model.AverageRating.Value.ToString("0.0") / 5</strong>
                    <span class="text-muted">(@Model.RatingCount değerlendirme)</span>
                </p>
            }
            else
            {
                <p class="text-muted mb-2">Henüz değerlendirme yapılmamış.</p>
            }

            @if (Model.CanRateUser)
            {
                <form asp-controller="Profile"
                      asp-action="Rate"
                      method="post"
                      class="row g-2 align-items-center mb-2">
                    @Html.AntiForgeryToken()
                    <input type="hidden" name="ratedUserId" value="@user.Id" />

                    <div class="col-auto">
                        <label for="stars" class="col-form-label">Puanınız:</label>
                    </div>
                    <div class="col-auto">
                        <select id="stars" name="stars" class="form-select form-select-sm">
                            @for (int i = 1; i <= 5; i++)
                            {
                                if (Model.ExistingRating == i)
                                {
                                    <option value="@i" selected>@i Yıldız</option>
                                }
                                else
                                {
                                    <option value="@i">@i Yıldız</option>
                                }
                            }
                        </select>
                    </div>
                    <div class="col-auto">
                        <button type="submit" class="btn btn-warning btn-sm">
                            <i class="bi bi-star me-1"></i>
                            @(Model.ExistingRating.HasValue ? "Puanı Güncelle" : "Puan Ver")
                        </button>
                    </div>
                </form>
                <p class="small text-muted">Sadece birlikte çalıştığınız kullanıcıları değerlendirebilirsiniz.</p>
            }

            <hr />

            <!-- WORK EXPERIENCE -->
            @if (user.Role.Name == "Worker" && user.WorkExperiences?.Any() == true)
            {
                <h5><i class="bi bi-hospital me-2"></i>Çalışma Geçmişi</h5>

                <ul class="list-group mb-3">
                    @foreach (var exp in user.WorkExperiences.OrderByDescending(x => x.StartDate))
                    {
                        <li class="list-group-item">
                            <strong>@exp.PharmacyName</strong><br />
                            <small class="text-muted">
                                @exp.StartDate.ToString("MM/yyyy")
                                -
                                @(exp.EndDate.HasValue
                                    ? exp.EndDate.Value.ToString("MM/yyyy")
                                    : "Devam ediyor")
                            </small>
                        </li>
                    }
                </ul>

                <p class="fw-bold">
                    <i class="bi bi-stopwatch me-2"></i>Toplam Deneyim:
                    @if (years > 0)
                    {
                        @($"{years} yıl ")
                    }
                    @if (months > 0)
                    {
                        @($"{months} ay")
                    }
                </p>

                <hr />
            }

            <!-- MESAJ -->
            @if (User.Identity?.IsAuthenticated == true && user.Id != int.Parse(User.FindFirst(ClaimTypes.NameIdentifier)!.Value))
            {
                if (Model.ConversationId.HasValue)
                {
                    <a asp-controller="Messages"
                       asp-action="Chat"
                       asp-route-id="@Model.ConversationId.Value"
                       class="btn btn-primary">
                        <i class="bi bi-chat-dots me-2"></i>Mesajlaşmaya Git
                    </a>
                }
                else if (Model.IncomingRequestId.HasValue)
                {
                    <form asp-controller="Messages"
                          asp-action="AcceptRequest"
                          asp-route-requestId="@Model.IncomingRequestId.Value"
                          method="post"
                          class="d-inline">
                        <button type="submit" class="btn btn-success">
                            <i class="bi bi-check-circle me-2"></i>Mesaj İsteğini Kabul Et
                        </button>
                    </form>
                }
                else if (Model.HasPendingOutgoingRequest)
                {
                    <button class="btn btn-outline-secondary" disabled>
                        <i class="bi bi-hourglass-split me-2"></i>Mesaj İsteği Gönderildi
                    </button>
                }
                else if (Model.CanSendRequest)
                {
                    <form asp-controller="Messages"
                          asp-action="Start"
                          asp-route-userId="@user.Id"
                          method="post"
                          class="d-inline">
                        <button type="submit" class="btn btn-primary">
                            <i class="bi bi-chat-dots me-2"></i>Mesaj İsteği Gönder
                        </button>
                    </form>
                }
            }

        </div>
    </div>
</div>
